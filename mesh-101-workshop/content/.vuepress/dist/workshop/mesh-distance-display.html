<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Building a meshed IoT-solution | IoT Workshop ‚Äì Particle Mesh</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.fb29996d.css" as="style"><link rel="preload" href="/assets/js/app.144ed3be.js" as="script"><link rel="preload" href="/assets/js/4.1cd39312.js" as="script"><link rel="preload" href="/assets/js/10.ae1be91d.js" as="script"><link rel="prefetch" href="/assets/js/1.ab95069a.js"><link rel="prefetch" href="/assets/js/2.86cc15e3.js"><link rel="prefetch" href="/assets/js/3.442fca65.js"><link rel="prefetch" href="/assets/js/5.233e3eb4.js"><link rel="prefetch" href="/assets/js/6.40e9948b.js"><link rel="prefetch" href="/assets/js/7.8ffe51da.js"><link rel="prefetch" href="/assets/js/8.544ff60d.js"><link rel="prefetch" href="/assets/js/9.8ea047fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fb29996d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      IoT Workshop ‚Äì Particle Mesh
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Particle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/nielsclausen/workshop-mesh-thingscon2018" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Particle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/nielsclausen/workshop-mesh-thingscon2018" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/workshop/" class="sidebar-link">Introduction</a></li><li><a href="/workshop/prerequisites.html" class="sidebar-link">Preparations</a></li><li><a href="/workshop/box-to-blinky.html" class="sidebar-link">1 ‚Äì From Box to Blinky</a></li><li><a href="/workshop/grove-kit-distance-display.html" class="sidebar-link">2 ‚Äì Measuring a distance</a></li><li><a href="/workshop/mesh-messaging.html" class="sidebar-link">3 ‚Äì Working in the Mesh</a></li><li><a href="/workshop/mesh-distance-display.html" class="active sidebar-link">4 ‚Äì Putting it all together</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/workshop/mesh-distance-display.html#remote-distance-sensor" class="sidebar-link">Remote distance sensor</a></li><li class="sidebar-sub-header"><a href="/workshop/mesh-distance-display.html#remote-display" class="sidebar-link">Remote display</a></li><li class="sidebar-sub-header"><a href="/workshop/mesh-distance-display.html#more-mesh" class="sidebar-link">More mesh?</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="putting-it-all-togehter"><a href="#putting-it-all-togehter" aria-hidden="true" class="header-anchor">#</a> Putting it all togehter</h1><div class="sbox-container" data-v-24264f9a><div class="sbox-table" data-v-24264f9a><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a>Goal </div><div class="sbox-content" data-v-24264f9a>Building a minimal mesh solution</div></div><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a> Time </div><div class="sbox-content" data-v-24264f9a> 25 min </div></div><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a> Tools </div><div class="sbox-content" data-v-24264f9a><ul data-v-24264f9a><li data-v-24264f9a>Argon</li><li data-v-24264f9a>Xenon</li><li data-v-24264f9a>2 Grove starter kits for Particle mesh</li></ul></div></div></div></div><p>In this session, it will all come together. One device is measuring a distance and broadcasting the value, while another is listening for updates and displaying them on a digital display.</p><h3 id="partner-up-with-your-neighbour"><a href="#partner-up-with-your-neighbour" aria-hidden="true" class="header-anchor">#</a> Partner up with your neighbour</h3><p>Also for this session, it is necessary to cooperate in groups of at least two participants. Group members will have to implement different code depending on the role of their device. One group member should implement the <em>remote distance sensor</em> code, the other(s) should implement the <em>remote display</em> code.</p><div class="tip custom-block"><p class="custom-block-title">Do yo come prepared?</p><p>It is assumed that you come to this session with an Argon and a Xenon on the same mesh network, and have working code from the previous sessions.</p></div><h2 id="remote-distance-sensor"><a href="#remote-distance-sensor" aria-hidden="true" class="header-anchor">#</a> Remote distance sensor</h2><p>In a <a href="/workshop/grove-kit-distance-display.html">previous session</a> you wrote code that read the distance from the ultrasonic distance sensor in the Grove sensor kit. Now we take those capabilities to the mesh. If you get stuck in the code, the final code for the remote distance measurer is <a href="https://go.particle.io/shared_apps/5c0718d14e3594c0cf00082f" target="_blank" rel="noopener noreferrer">available here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p><ol><li><p>In the <a href="https://build.particle.io" target="_blank" rel="noopener noreferrer">Particle Web IDE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, make a new app and call it &quot;RemoteDistanceSensor&quot; (or come up with a more creative name).</p></li><li><p>Add the Grove-Ultrasonic-Ranger library to the app.</p></li><li><p>Copy paste the part of the code that did the reading of the sensor in the 2nd lab. It should look something like the following (delete the automatically added <code>#include</code> line when importing the library).</p></li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;Ultrasonic.h&quot;</span></span>

Ultrasonic <span class="token function">ultrasonic</span><span class="token punctuation">(</span>D2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> lastRange <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> range<span class="token punctuation">;</span>

	Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Obstacle found at:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	range <span class="token operator">=</span> ultrasonic<span class="token punctuation">.</span><span class="token function">MeasureInCentimeters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//0~400cm</span>
	Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; cm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> lastRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    lastRange <span class="token operator">=</span> range<span class="token punctuation">;</span>

        <span class="token comment">// Publish measurement</span>

	<span class="token punctuation">}</span>
    
	<span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Now take that reading and publish it to the mesh network. The group needs to agree on a name for the event ‚Äì in the example we will use <code>distance</code>. Insert the <code>mesh.publish</code> function instead of the <em>Publish measurement</em> comment line. Convert the range number to a <em>String</em> before publishing it.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Mesh<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;distance&quot;</span><span class="token punctuation">,</span><span class="token function">String</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>Upload this code to the device connected to the distance sensor.</li></ol><p>You now have a working distance sensor publishing its readings to the network.</p><h2 id="remote-display"><a href="#remote-display" aria-hidden="true" class="header-anchor">#</a> Remote display</h2><p>Let's build a remote distance display. If you get stuck in the code, the final code for the remote distance measurer is <a href="https://go.particle.io/shared_apps/5c0711444e3594b2630006e0" target="_blank" rel="noopener noreferrer">available here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p><ol><li><p>Make a new app for the displaying device and call it &quot;Remote4DigitDisplay&quot; (feel free to freestyle the name though).</p></li><li><p>Add the <code>Grove_4Digit_Display</code> library to the app.</p></li><li><p>Replace the include statement that was added with <code>#include &quot;TM1637.h&quot;</code>.</p></li><li><p>Define the pins used for the display, create a display variable and initialize the display. The app should now look something like this.</p></li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;TM1637.h&quot;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> CLK D4 </span>
<span class="token macro property">#<span class="token directive keyword">define</span> DIO D5</span>

TM1637 <span class="token function">disp</span><span class="token punctuation">(</span>CLK<span class="token punctuation">,</span>DIO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	disp<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    disp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>BRIGHT_TYPICAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>You can now run the code, but it will not do anything interesting. So let's subscribe to the event data pulished by the other device in our mesh network. Add the subscription line to the <code>setup</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Mesh<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;distance&quot;</span><span class="token punctuation">,</span> displayDistance<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>Now, every time the device receives a <code>distance</code> event, the function <code>displayDistance</code> will be called. We will write this function now. Insert the function above the <code>setup</code> function, and simply just write the received String to the terminal.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">displayDistance</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Mesh 'distance' event received with data: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>Right now the number is stored as a String, so it needs to be converted to an integer (int). This is simply done by the build-in <code>atoi</code> function. Insert the following line right before the print statements.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// Convert String (data) to int (range)</span>
<span class="token keyword">int</span> range <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="8"><li>Now that you have an interger, you can display the value in the 4-digit display. First declare these two variables in the beginning of the <code>displayDistance</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> digit<span class="token punctuation">;</span>
<span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre></div><ol start="9"><li>Then paste the <code>for</code>and <code>while</code> loop you used previously with the display, to the bottom of the <code>displayDistance</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// Fill display with zeros</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    disp<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Extract each digit from the range and write it to the display</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>range <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the current digit by performing modulo (%) division on the range</span>
    digit  <span class="token operator">=</span> range <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">// Remove the trailing digit by whole-number division</span>
    range <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    
    disp<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> digit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pos<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="10"><li>Upload this code to the device connected to the distance sensor.</li></ol><p>Now, every time a distance measurement is broadcasted by the , the display is updated, hooray!!!</p><p>This concludes the workshop üéâ</p><div class="tip custom-block"><p class="custom-block-title">Feedback for the workshop</p><p>If you fill out this <a href="https://goo.gl/forms/jQFWiEgWw7WCjIXM2" target="_blank" rel="noopener noreferrer">5 question survey<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we may improve this workshop to benefit future <em>workshoppers</em>, or just pad ourselves on the back for doing great.</p></div><h2 id="more-mesh"><a href="#more-mesh" aria-hidden="true" class="header-anchor">#</a> More mesh?</h2><p>Feel you want more mesh? Try adding features to your IoT mesh solution see these <a href="/workshop/extra.html">hidden hints</a>.</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê <a href="/workshop/mesh-messaging.html" class="prev">
          3 ‚Äì Working in the Mesh
        </a></span><!----></p></div></div></div></div>
    <script src="/assets/js/4.1cd39312.js" defer></script><script src="/assets/js/10.ae1be91d.js" defer></script><script src="/assets/js/app.144ed3be.js" defer></script>
  </body>
</html>
