<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Messaging in the mesh | IoT Workshop ‚Äì Particle Mesh</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.fb29996d.css" as="style"><link rel="preload" href="/assets/js/app.144ed3be.js" as="script"><link rel="preload" href="/assets/js/3.442fca65.js" as="script"><link rel="preload" href="/assets/js/10.ae1be91d.js" as="script"><link rel="prefetch" href="/assets/js/1.ab95069a.js"><link rel="prefetch" href="/assets/js/2.86cc15e3.js"><link rel="prefetch" href="/assets/js/4.1cd39312.js"><link rel="prefetch" href="/assets/js/5.233e3eb4.js"><link rel="prefetch" href="/assets/js/6.40e9948b.js"><link rel="prefetch" href="/assets/js/7.8ffe51da.js"><link rel="prefetch" href="/assets/js/8.544ff60d.js"><link rel="prefetch" href="/assets/js/9.8ea047fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fb29996d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      IoT Workshop ‚Äì Particle Mesh
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Particle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/nielsclausen/workshop-mesh-thingscon2018" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Particle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/nielsclausen/workshop-mesh-thingscon2018" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/workshop/" class="sidebar-link">Introduction</a></li><li><a href="/workshop/prerequisites.html" class="sidebar-link">Preparations</a></li><li><a href="/workshop/box-to-blinky.html" class="sidebar-link">1 ‚Äì From Box to Blinky</a></li><li><a href="/workshop/grove-kit-distance-display.html" class="sidebar-link">2 ‚Äì Measuring a distance</a></li><li><a href="/workshop/mesh-messaging.html" class="active sidebar-link">3 ‚Äì Working in the Mesh</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/workshop/mesh-messaging.html#setting-up-the-mesh-network" class="sidebar-link">Setting up the mesh network</a></li><li class="sidebar-sub-header"><a href="/workshop/mesh-messaging.html#sending-receiving-messages" class="sidebar-link">Sending &amp; Receiving messages</a></li></ul></li><li><a href="/workshop/mesh-distance-display.html" class="sidebar-link">4 ‚Äì Putting it all together</a></li></ul></div><div class="page"><div class="content"><h1 id="how-to-mesh"><a href="#how-to-mesh" aria-hidden="true" class="header-anchor">#</a> How to Mesh</h1><div class="sbox-container" data-v-24264f9a><div class="sbox-table" data-v-24264f9a><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a>Goal </div><div class="sbox-content" data-v-24264f9a>Publish and receive messages to/from the mesh.</div></div><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a> Time </div><div class="sbox-content" data-v-24264f9a> 20 min </div></div><div class="sbox-row" data-v-24264f9a><div class="sbox-header" data-v-24264f9a> Tools </div><div class="sbox-content" data-v-24264f9a><ul data-v-24264f9a><li data-v-24264f9a>Argon</li><li data-v-24264f9a>Xenon</li><li data-v-24264f9a>2 Grove starter kits for Particle mesh</li></ul></div></div></div></div><p>In this session, we'll leverage a local mesh network to quickly send messages between devices. We'll get a LED to turn on/off when the button on a different device is pushed.</p><h3 id="work-in-groups"><a href="#work-in-groups" aria-hidden="true" class="header-anchor">#</a> Work in groups</h3><p>From now on and the rest of the workshop, it is necessary to cooperate in groups of 2-3 participants. Each group will get a Xenon, and from this point on in the workshop, the group will now work with one Argon and one Xenon.</p><div class="tip custom-block"><p class="custom-block-title">Do yo come prepared?</p><p>It is assumed that you come to this session with an Argon that you are able to program.</p></div><h2 id="setting-up-the-mesh-network"><a href="#setting-up-the-mesh-network" aria-hidden="true" class="header-anchor">#</a> Setting up the mesh network</h2><p>In order to set up a mesh network, you need one device with internet connection, acting as a gateway. This device will create a mesh network, other devices (currently only Xenons) can join. These devices will be the <em>nodes</em> of the mesh network. This part will guide you trhough setting up an Argon as a gateway, and a Xenon as a node.</p><p>This video walks you through it. You may follow along the 12 steps hereunder along with it, as the video has no sound.</p><div align="center"><iframe width="250" height="400" src="https://www.youtube.com/embed/MJ3aon2953I" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen="allowfullscreen"></iframe></div><ol><li><p>From the Particle app, add the Argon as a new device, even if it has already been added. This will not override your code on the device. Follow the steps from the previous lab, but select the option to use the Argon in a mesh network.</p></li><li><p>Follow the guide to add WiFi to your Argon.</p></li><li><p>After the Argon has connected to the Device Cloud, name your Argon.</p></li><li><p>Give your new mesh network a name (max 16 characters) and a password.</p></li><li><p>After the mesh network is successfully created, you may exit the setup guide, and set up the Xenon.</p></li><li><p>Add the Xenon in much the same fashion you added the Argon: Start from the &quot;Your devices&quot; and click on the &quot;+&quot; sign.</p></li><li><p>Hold the <code>Mode</code> button for 3 seconds to put the Xenon into listening mode.</p></li><li><p>Scan the sticker. The Xenon will now pair with your phone.</p></li><li><p>After successful pairing, the Xenon will scan for local mesh-networks. Chose the network you set up with the Argon before.</p></li><li><p>To connect a new device to the mesh network, you physical access to a device already on the mesh network. This device will act as a commisioner, allowing your new device to join. Put the Argon (already on the mesh network) in listening mode (blinking blue) by holding the <code>MODE</code> button down for 3 seconds. Then scan its sticker.</p></li><li><p>Once you have successfully paired with the Argon, enter the mesh network password you created earlier.</p></li><li><p>After your Xenon have successfully joined the mesh network, you may give it a name, and exit the setup guide.</p></li></ol><p>You now have a functioning</p><h2 id="sending-receiving-messages"><a href="#sending-receiving-messages" aria-hidden="true" class="header-anchor">#</a> Sending &amp; Receiving messages</h2><p>Let us take a look at two of the newest functions provided by Particle: <code>Mesh.publish()</code> and <code>Mesh.subscribe()</code>. These primitives allow you to send and receive messages within a Particle Mesh network. These messages will not reach the cloud. Each device can publish messages to ther rest of the mesh, and each device can subscribe to messages from other devices ‚Äì¬†this is called a <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" target="_blank" rel="noopener noreferrer">pub/sub architecture<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p><p>The same code will be used for all devices in the network, so start by creating a new app in the <a href="https://build.particle.io/build/new" target="_blank" rel="noopener noreferrer">Particle Web IDE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, name it <em>MeshPubSubTest.ino</em> or come up with a more creative name.</p><h3 id="sending-messages"><a href="#sending-messages" aria-hidden="true" class="header-anchor">#</a> Sending messages</h3><p>First, let's send out a message when the <code>MODE</code> button on the Argon is pushed.</p><ol><li>In the <code>setup</code> function, tell the device to call the <code>button_handler</code> function, whenever the <code>button_status</code> changes (pressed or released).</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>System<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>button_status<span class="token punctuation">,</span> button_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>Now write the <code>button_handler</code> function before the <code>setup</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">button_handler</span><span class="token punctuation">(</span>system_event_t event<span class="token punctuation">,</span> <span class="token keyword">int</span> duration<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Empty</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Since this function gets called on both press <em>and</em> release of the <code>MODE</code> button, we can use the <code>duration</code> to check which it is. Replace the line the the <em>Empty</em> comment with the following.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Just pressed.</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>Now, since we now that the button has been pressed, we should tell the whole mesh network to toggle their LEDs. We use the <code>Mesh.publish()</code> for that, which takes one or two striings as arguments. The first argument is a topic and the second is data. We will only use the topic, and we should choose a topic that will make sense for the purpose. Later other devices will be able to subscribe to this topic and will get notified whenever we publish to this topic. Replace the <em>Just pressed</em> comment line with this line, to finish the code.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Mesh<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;toggle-led&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>You have now completed the sending part of the code. To see that everything works, first add the following line to the <code>setup</code>.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>Then add a print statement like this inside the if-loop, just under the <code>mesh.publish</code> line.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Button push published!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>Flash your device with the code, and see that it behaves as expected.</li></ol><h3 id="receiving-messages"><a href="#receiving-messages" aria-hidden="true" class="header-anchor">#</a> Receiving messages</h3><p>We now want to subsribe to any messages on the <code>toggle-led</code> topic (or whatever you have decided to call it).</p><ol><li>First off, we need to define two variables that we will use to control the onboard LED. In the very top of the code, insert the following lines of code.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// Define the pin connected to the onboard LED (not the big RGB one, but the smaller one just right of the USB).</span>
<span class="token keyword">int</span> ledPin <span class="token operator">=</span> D7<span class="token punctuation">;</span>

<span class="token comment">// Set the initial state to ON (true).</span>
<span class="token keyword">bool</span> ledStatus <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>Then initialize the LED by making its pin writable and write its inital status. This code is inserted in the <code>setup</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">pinMode</span><span class="token punctuation">(</span>ledPin<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">digitalWrite</span><span class="token punctuation">(</span>ledPin<span class="token punctuation">,</span> ledStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Update the physical LED</span>
</code></pre></div><ol start="3"><li>In the <code>setup</code> function, subscribe to the <code>toggle-led</code> topic (first argument), and tell the device which function to call (second argument) when another device broadcasts a message to the topic.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Mesh<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;toggle-led&quot;</span><span class="token punctuation">,</span> toggleLed<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>Write the function that handles incoming messages to the <code>toggle-led</code>topic. Insert the function before the <code>setup</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">toggleLed</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Empty line</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>Put logic in the function that switches the status of the LED, and then update the physical LED to the new status. The following code replaces the <em>Empty line</em> comment line in the <code>toggleLed</code>function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// Toggle the status of the LED.</span>
ledStatus <span class="token operator">=</span> <span class="token operator">!</span>ledStatus<span class="token punctuation">;</span>

<span class="token comment">// Update the state of the physical LED by writing the value to the pin</span>
<span class="token function">digitalWrite</span><span class="token punctuation">(</span>ledPin<span class="token punctuation">,</span> ledStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>To see that everything works add the two print statements like these at the bottom of the <code>toggleLed</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;LED status toggled. Status: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>ledStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>Flash the code containg both receiving and sending code to your device. You have now completed the receiving part of the code. Since all devices  Try and push the <code>MODE</code> button on one of the devices in the mesh network, then see if the LEDs on the other devices are toggled.</li></ol><p>üéâ Congratulations, you are now able to send/receive messages to/from the mesh network. Easy, right?</p><div class="tip custom-block"><p class="custom-block-title">Got stuck in the code?</p><p>The final code for this lab is <a href="https://go.particle.io/shared_apps/5bf709ee4a72e15412000614" target="_blank" rel="noopener noreferrer">available here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></div></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê <a href="/workshop/grove-kit-distance-display.html" class="prev">
          2 ‚Äì Measuring a distance
        </a></span><span class="next"><a href="/workshop/mesh-distance-display.html">
          4 ‚Äì Putting it all together
        </a> ‚Üí
      </span></p></div></div></div></div>
    <script src="/assets/js/3.442fca65.js" defer></script><script src="/assets/js/10.ae1be91d.js" defer></script><script src="/assets/js/app.144ed3be.js" defer></script>
  </body>
</html>
